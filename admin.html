<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Angolo Divino</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --bg: #f4f4f4; --card: #fff; --text: #111; --accent: #000; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: 50px; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #eee; }
        
        /* DATE NAV */
        .date-nav { display: flex; gap: 10px; margin-bottom: 20px; }
        input[type="date"] { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1.1em; flex: 1; font-family: inherit; }
        button { cursor: pointer; font-family: inherit; }

        /* DAY CONFIG */
        .config-row { display: flex; gap: 15px; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .switch-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid #ccc; background: #eee; font-weight: 500; }
        .switch-btn.active { background: #000; color: #fff; border-color: #000; }
        
        input[type="time"], input[type="number"] { padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: center; font-weight: bold; width: 100px; }

        /* LIST */
        .res-item { 
            padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between;
        }
        .res-time { font-weight: 700; width: 60px; }
        .res-info { flex: 1; }
        .res-guests { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.85em; font-weight: bold; margin-left: 5px; }
        .btn-del { color: red; border: none; background: none; font-size: 1.2em; cursor: pointer; }

        .btn-save { width: 100%; background: #000; color: #fff; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 1em; }

        /* LOGIN */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 99; display: flex; align-items: center; justify-content: center; }
        .login-box { width: 300px; text-align: center; }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2>Admin</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()" class="btn-save">ENTRA</button>
    </div>
</div>

<div class="container" id="admin-content" style="display:none;">
    <div class="header">
        <h2>Gestione Giorno</h2>
        <button onclick="auth.signOut().then(()=>location.reload())" style="background:none; border:none; text-decoration:underline;">Esci</button>
    </div>

    <div class="date-nav">
        <button onclick="changeDate(-1)">◀</button>
        <input type="date" id="admin-date" onchange="loadDay()">
        <button onclick="changeDate(1)">▶</button>
    </div>

    <div class="card">
        <div class="config-row">
            <span>Stato:</span>
            <div>
                <button id="btn-open" class="switch-btn" onclick="setStatus(true)">APERTO</button>
                <button id="btn-closed" class="switch-btn" onclick="setStatus(false)">CHIUSO</button>
            </div>
        </div>
        
        <div id="hours-config">
            <div class="config-row">
                <span>Orario (Inizio - Fine):</span>
                <div>
                    <input type="time" id="t-start"> - <input type="time" id="t-end">
                </div>
            </div>
            <div class="config-row">
                <span>Capienza Max:</span>
                <input type="number" id="t-cap">
            </div>
        </div>
        <button class="btn-save" onclick="saveConfig()">SALVA MODIFICHE</button>
    </div>

    <div class="card">
        <h3 style="margin-top:0;">Prenotazioni (<span id="count">0</span>/ <span id="max-cap">0</span>)</h3>
        <div id="res-list"></div>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG (INCOLLA QUI) ---
    const firebaseConfig = {
    apiKey: "AIzaSyCs-6L3xP7_jhhatlAsS_U02Ye-92_AEXk",
    authDomain: "reservationsystem-64c22.firebaseapp.com",
    databaseURL: "https://reservationsystem-64c22-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "reservationsystem-64c22",
    storageBucket: "reservationsystem-64c22.firebasestorage.app",
    messagingSenderId: "663648362391",
    appId: "1:663648362391:web:6fbfb130761478eceeeed2"
  };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let dayData = { isOpen: true, start: "19:00", end: "23:00", capacity: 50 };

    auth.onAuthStateChanged(u => {
        if(u) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
            document.getElementById('admin-date').valueAsDate = new Date();
            loadDay();
        }
    });

    function login() {
        auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value)
        .catch(e => alert(e.message));
    }

    function changeDate(d) {
        const inp = document.getElementById('admin-date');
        const dt = new Date(inp.value);
        dt.setDate(dt.getDate() + d);
        inp.value = dt.toISOString().split('T')[0];
        loadDay();
    }

    function loadDay() {
        const date = document.getElementById('admin-date').value;
        
        // Load Config
        db.ref('calendar/'+date).once('value', snap => {
            dayData = snap.val() || { isOpen: true, start: "19:00", end: "23:00", capacity: 50 };
            renderConfig();
        });

        // Load Bookings
        db.ref('prenotazioni').orderByChild('date').equalTo(date).on('value', snap => {
            renderList(snap.val() || {});
        });
    }

    function renderConfig() {
        document.getElementById('btn-open').className = `switch-btn ${dayData.isOpen ? 'active' : ''}`;
        document.getElementById('btn-closed').className = `switch-btn ${!dayData.isOpen ? 'active' : ''}`;
        document.getElementById('hours-config').style.opacity = dayData.isOpen ? '1' : '0.3';
        
        document.getElementById('t-start').value = dayData.start;
        document.getElementById('t-end').value = dayData.end;
        document.getElementById('t-cap').value = dayData.capacity;
    }

    function setStatus(s) { dayData.isOpen = s; renderConfig(); }

    function saveConfig() {
        const date = document.getElementById('admin-date').value;
        const data = {
            isOpen: dayData.isOpen,
            start: document.getElementById('t-start').value,
            end: document.getElementById('t-end').value,
            capacity: parseInt(document.getElementById('t-cap').value)
        };
        db.ref('calendar/'+date).set(data).then(() => alert("Salvato!"));
    }

    function renderList(data) {
        const list = document.getElementById('res-list');
        list.innerHTML = "";
        let count = 0;
        let books = Object.entries(data).map(([k,v]) => ({...v, key: k}));
        
        books.sort((a,b) => a.time.localeCompare(b.time));

        books.forEach(b => {
            count += parseInt(b.guests);
            list.innerHTML += `
                <div class="res-item">
                    <div class="res-time">${b.time}</div>
                    <div class="res-info">
                        <strong>${b.name}</strong> <span class="res-guests">${b.guests}p</span><br>
                        <small style="color:#666;">${b.phone}</small>
                        ${b.notes ? `<br><small style="background:#fff3cd;">${b.notes}</small>` : ''}
                    </div>
                    <button class="btn-del" onclick="del('${b.key}')">×</button>
                </div>
            `;
        });
        document.getElementById('count').innerText = count;
        document.getElementById('max-cap').innerText = dayData.capacity || 50;
    }

    function del(k) {
        if(confirm("Eliminare?")) db.ref('prenotazioni/'+k).remove();
    }
</script>
</body>
</html>

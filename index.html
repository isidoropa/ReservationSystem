<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prenota il Tuo Tavolo</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root {
            --bg: #1a1a1a;
            --card: #2d2d2d;
            --gold: #d4af37;
            --text: #f0f0f0;
            --disabled: #555;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Lato', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 100px; }

        h1, h2, h3 { font-family: 'Playfair Display', serif; color: var(--gold); margin: 0; }
        h1 { text-align: center; font-size: 2.2em; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #888; font-size: 0.9em; margin-bottom: 30px; letter-spacing: 2px; text-transform: uppercase; }

        .step-card {
            background: var(--card); border-radius: 16px; padding: 20px;
            margin-bottom: 20px; border: 1px solid #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: 0.3s;
        }
        .step-title { font-size: 1.1em; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .step-number { background: var(--gold); color: var(--bg); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8em; }

        /* STEP 1: GUESTS */
        .guests-control { display: flex; align-items: center; justify-content: space-between; background: #222; padding: 10px; border-radius: 10px; }
        .guest-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: #444; color: white; font-size: 1.5em; cursor: pointer; }
        .guest-display { font-size: 1.5em; font-weight: bold; color: var(--gold); }

        /* STEP 2: DATE */
        input[type="date"], input[type="text"], input[type="tel"], textarea {
            width: 100%; padding: 15px; background: #222; border: 1px solid #444;
            color: white; border-radius: 10px; font-size: 1.1em; font-family: inherit;
            color-scheme: dark; outline: none;
        }
        input:focus { border-color: var(--gold); }

        /* STEP 3: TIME SLOTS */
        .slots-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .time-slot {
            padding: 12px; background: #222; border: 1px solid #444; border-radius: 8px;
            text-align: center; cursor: pointer; transition: 0.2s; font-weight: bold;
        }
        .time-slot.selected { background: var(--gold); color: var(--bg); border-color: var(--gold); }
        .time-slot.full { opacity: 0.3; pointer-events: none; text-decoration: line-through; border-color: #333; }
        .slot-info { display: block; font-size: 0.7em; font-weight: normal; margin-top: 2px; }

        /* CONFIRM BUTTON */
        .bottom-bar {
            position: fixed; bottom: 20px; left: 20px; right: 20px;
            background: rgba(45, 45, 45, 0.95); backdrop-filter: blur(10px);
            padding: 15px; border-radius: 12px; border: 1px solid #444;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100; text-align: center;
        }
        .btn-confirm {
            width: 100%; background: var(--gold); color: var(--bg); border: none;
            padding: 15px; border-radius: 8px; font-weight: bold; font-size: 1.1em;
            cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-confirm:disabled { background: #555; color: #888; cursor: not-allowed; }

        .hidden { display: none; }
        .error-msg { color: #e74c3c; font-size: 0.9em; margin-top: 5px; display: none; }
    </style>
</head>
<body>

    <h1>L'Angolo Divino</h1>
    <div class="subtitle">Prenotazioni Online</div>

    <div class="step-card">
        <div class="step-title"><span class="step-number">1</span> Quante persone?</div>
        <div class="guests-control">
            <button class="guest-btn" onclick="changeGuests(-1)">-</button>
            <span class="guest-display" id="guest-count">2</span>
            <button class="guest-btn" onclick="changeGuests(1)">+</button>
        </div>
    </div>

    <div class="step-card">
        <div class="step-title"><span class="step-number">2</span> Scegli la Data</div>
        <input type="date" id="date-picker" onchange="loadAvailability()">
    </div>

    <div class="step-card" id="step-time" style="opacity:0.5; pointer-events:none;">
        <div class="step-title"><span class="step-number">3</span> Seleziona Orario</div>
        <div id="slots-container" class="slots-grid">
            <div style="grid-column: span 3; text-align:center; color:#666;">Seleziona prima una data</div>
        </div>
        <div class="error-msg" id="no-slots-msg">Nessun tavolo disponibile per questa data/gruppo.</div>
    </div>

    <div class="step-card hidden" id="step-contact">
        <div class="step-title"><span class="step-number">4</span> I tuoi dati</div>
        <label>Nome Prenotazione</label>
        <input type="text" id="name" placeholder="Es. Marco Rossi" style="margin-bottom:10px;">
        <label>Telefono (per conferma)</label>
        <input type="tel" id="phone" placeholder="333 1234567">
        <textarea id="notes" rows="2" placeholder="Note (es. Seggiolone, Allergie...)" style="margin-top:10px;"></textarea>
    </div>

    <div class="bottom-bar">
        <button id="btn-submit" class="btn-confirm" onclick="submitReservation()" disabled>PRENOTA TAVOLO</button>
    </div>

<script>
    // --- CONFIGURAZIONE ---
    const firebaseConfig = {
    apiKey: "AIzaSyCs-6L3xP7_jhhatlAsS_U02Ye-92_AEXk",
    authDomain: "reservationsystem-64c22.firebaseapp.com",
    databaseURL: "https://reservationsystem-64c22-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "reservationsystem-64c22",
    storageBucket: "reservationsystem-64c22.firebasestorage.app",
    messagingSenderId: "663648362391",
    appId: "1:663648362391:web:6fbfb130761478eceeeed2"
  };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // VARIABILI STATO
    let guests = 2;
    let selectedDate = null;
    let selectedTime = null;
    let restaurantConfig = {
        capacity: 50, // Coperti totali del locale
        slots: ["19:00", "19:30", "20:00", "20:30", "21:00", "21:30", "22:00"]
    };

    // INIT
    window.onload = () => {
        // Imposta data minima a oggi
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date-picker').min = today;
        
        // Carica config dal DB (se esiste, altrimenti usa default)
        db.ref('settings').once('value', snap => {
            if(snap.val()) restaurantConfig = snap.val();
        });
    };

    // GESTIONE GUESTS
    function changeGuests(delta) {
        guests += delta;
        if(guests < 1) guests = 1;
        if(guests > 20) guests = 20; // Limite max gruppo
        document.getElementById('guest-count').innerText = guests;
        if(selectedDate) loadAvailability(); // Ricalcola se cambia il numero
    }

    // CARICAMENTO DISPONIBILITÀ (CUORE DEL SISTEMA)
    function loadAvailability() {
        const dateInput = document.getElementById('date-picker').value;
        if(!dateInput) return;
        selectedDate = dateInput;

        // Attiva UI
        const stepTime = document.getElementById('step-time');
        stepTime.style.opacity = "1";
        stepTime.style.pointerEvents = "auto";
        document.getElementById('slots-container').innerHTML = '<div style="grid-column:span 3; text-align:center;">Verifico disponibilità...</div>';

        // Scarica prenotazioni per quella data
        db.ref('prenotazioni').orderByChild('date').equalTo(selectedDate).once('value', snap => {
            const bookings = snap.val() || {};
            renderSlots(bookings);
        });
    }

    function renderSlots(bookings) {
        const container = document.getElementById('slots-container');
        container.innerHTML = "";
        let availableSlotsCount = 0;

        restaurantConfig.slots.forEach(time => {
            // Calcola quanti posti sono occupati a quest'ora
            let occupied = 0;
            Object.values(bookings).forEach(b => {
                if(b.time === time) occupied += b.guests;
            });

            const remaining = restaurantConfig.capacity - occupied;
            const isFull = remaining < guests; // Se i posti rimasti sono meno di quelli che voglio prenotare

            const div = document.createElement('div');
            div.className = `time-slot ${isFull ? 'full' : ''}`;
            div.innerHTML = `${time} <span class="slot-info">${isFull ? 'Pieno' : remaining + ' liberi'}</span>`;
            
            if(!isFull) {
                div.onclick = () => selectTime(div, time);
                availableSlotsCount++;
            }

            container.appendChild(div);
        });

        if(availableSlotsCount === 0) {
            document.getElementById('no-slots-msg').style.display = "block";
        } else {
            document.getElementById('no-slots-msg').style.display = "none";
        }
    }

    function selectTime(el, time) {
        // Rimuovi selezione precedente
        document.querySelectorAll('.time-slot').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
        selectedTime = time;
        
        // Mostra step successivo
        document.getElementById('step-contact').classList.remove('hidden');
        checkForm();
    }

    // VALIDAZIONE FORM
    ['name', 'phone'].forEach(id => {
        document.getElementById(id).addEventListener('input', checkForm);
    });

    function checkForm() {
        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const btn = document.getElementById('btn-submit');
        
        if(selectedTime && name && phone.length > 5) {
            btn.disabled = false;
            btn.innerText = `CONFERMA PER ${guests} PERSONE`;
        } else {
            btn.disabled = true;
        }
    }

    // INVIO PRENOTAZIONE
    function submitReservation() {
        if(!confirm(`Confermi la prenotazione per ${guests} persone il ${selectedDate} alle ${selectedTime}?`)) return;

        const btn = document.getElementById('btn-submit');
        btn.disabled = true;
        btn.innerText = "REGISTRAZIONE...";

        const data = {
            date: selectedDate,
            time: selectedTime,
            guests: guests,
            name: document.getElementById('name').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            notes: document.getElementById('notes').value.trim(),
            timestamp: Date.now(),
            status: 'confirmed' // Auto-conferma per disponibilità verificata
        };

        db.ref('prenotazioni').push(data)
        .then(() => {
            alert("✅ Prenotazione Confermata! Ti aspettiamo.");
            location.reload();
        })
        .catch(e => {
            alert("Errore: " + e.message);
            btn.disabled = false;
        });
    }
</script>
</body>
</html>